---
title: "A is for Astronaut"
date: 2023-10-06
description: "Astroでサイトを書き直した"
tags: ["tech", "web", "astro"]
emoji: "🚀"
---

## 概要

1年半ほど Next.js で運用してきたサイトを [Astro](https://astro.build) で書き直した。

## 実装のポイント

### Freeze everything :snowflake:

あるサイトが検索結果に現れた。フロントエンドの技術を調べていたときだった。サイトの概要文にはいくつかのキーワードが見えた——「（あるモダンなフレームワークの名前）」、「静的サイト生成」、云々、云々。とっても素晴らしい。期待してアクセスした。

ページに入ると、はじめにブラウザのデフォルトのフォントでレンダリングがおこなわれた。見たところこのサイトは、余分な装飾も少なく、比較的**ミニマル**らしい。そう思ったとたん、画面がフラッシュし、スタイリッシュな字体がドカッと降ってきた。Web フォントのお出ましだ。息つく間もなく、確定済みのレイアウトを押しのけて外部画像が割り込んでくる。同時に、埋め込まれていた `<iframe>` が正体を現し、なにやらスクリプトもガチャガチャとロードされた。この間およそ数秒。

いったい何が起こったのか？

答え：たとえ静的生成（SSG）されたサイトであっても、すべてのリソースがビルド時に解決されるわけではない。Google Fonts 用のスタイルシートや、外部の画像への参照、`<iframe>` による外部コンテンツの呼び出し……こうしたリソースの解決はしばしばクライアント側に委ねられ、（よほどひどい場合）上のような事態をもたらす。逆にいえば、もし SSG をさらにチューニングするのなら、このあたりには改善の余地がある。単純な話だ。とにかく、可能な限りのものをビルド時に**凍結**して、バンドルに含めてしまえばいい。たいていの場合、なにごとも決定的であるほうが嬉しいのだから。

#### 1. リンクカード内の画像

[以前の実装](/blog/posts/blog-renewal) 以来、Markdown 内の単独のリンクはリンクカード（:point_down: こういうの）に変換され、リンク先の Open Graph 画像などが表示されるようになっていた。

https://ogp.me/

この画像は外部のものをそのままリンクしていたので、[Lighthouse](https://developer.chrome.com/ja/docs/lighthouse/) のパフォーマンス診断をかけると、サイズがデカすぎるから減らせと怒鳴られることがあった。そこで、画像をいったん取得し、[sharp](https://sharp.pixelplumbing.com/) で適正なサイズに縮小（ついでに WebP に変換）して base64 形式でドキュメントに埋め込んだ。これでクライアント側での余剰なリクエストが減り、総転送量が抑えられる。

代償として、1. ドキュメント自体のサイズが増え、また 2. ビルド時間がやや長くなる ところだが、さいわいこの記事数・画像数ではそれほどの影響はなかった。さらにいえば画像の取得結果は軽くキャッシュされる実装になっているので、一度アクセスすれば（少なくとも開発サーバのセッション内では）応答速度も悪くない。

#### 2. OG画像の生成

こちらから提供する OG 画像についても、Edge Function で動的に応答させる方式を改め、ビルド時に生成することとした。静的ファイルのエンドポイントを作成する機能を使い、記事一覧から勝手に画像が生えてくるようにしている。

https://docs.astro.build/ja/core-concepts/endpoints/

![ペンギン](/image/linux-tools-2022.png)

#### 3. `@fontsource-variable` の活用

Web フォントを NPM パッケージからインポートすることで、まとめてバンドルし、セルフホストできる。こういうことができるのは JavaScript のフレームワークを使う強みだ。

せっかくなので[バリアブルフォント](https://developer.mozilla.org/ja/docs/Web/CSS/CSS_fonts/Variable_fonts_guide)を使ってみた。軽量で便利なのではやく普及してほしい。地に平和がありますように。バリアブルフォントが広まりますように。

### 画像処理のワークフロー :factory:

Astro v3 では、Markdown / MDX 内の画像を最適化する[いくつかの方法](https://docs.astro.build/ja/guides/images/)が公式に提供されている。しかしながら、それらはみな

1. 「MDX や Astro コンポーネントの内部で**個別に画像をインポート**し / `<Image>` コンポーネントに代入して処理をカスタマイズする」
2. 「通常の Markdown の記法で画像を挿入し / Astro 側が自動で行う処理に甘んじる」

のいずれかであって、 3. 「Markdown の記法で挿入し / `<Image>` コンポーネントでカスタマイズ」したい私の願いとは相容れなかった。そのため、Markdown の処理時に `<img>` 要素を `<Image>` コンポーネントに[置き換える](https://docs.astro.build/ja/guides/markdown-content/#カスタムコンポーネントをhtml要素に割り当てる)方法で対応した。

注意点としては、

- コンポーネントの置き換えを使うには、たとえファイル名だけでも `.mdx` にしなければならない（Plain Markdownでは不可能）
- 最終的にバンドルに含められる関係上、`<Image>` 内の画像は必ずどこかでインポートしたものでなければならない

など。後者については、個別の画像ごとではなく、`import.meta.glob()` を使ってフォルダ内の画像をまるごとインポートすることで対処した。概ね Vite が有能すぎるという結論でよい。

### スタイル面・その他 :sparkles:

スタイルは大きくは変えていないが、ちょっと「洗練」が入った（要検証）。あとリセット CSS (`preflight.css`) のみを残し、Tailwind を剥がした。

ホスト先は Vercel + Cloudflare の二重構成をやめ、Cloudflare Pages にがっちり腰を据えた。

## 総評

全体的に開発体験が良くなった。[コンテンツコレクション](https://docs.astro.build/ja/guides/content-collections/)のおかげで Markdown / MDX に型が付くし、Vite ベースのモダンなエコシステムでスマートにやっていけるのは嬉しい。

パフォーマンスについては以前の実装でも十分すぎるほどだったが、今回の改修で全体の転送量がかなり減った。

~~ところで記事のほうは何か増やされたんですか？~~

---
title: "systemdã«å…¨éƒ¨è³­ã‘ã‚ï¼ˆç¬¬äºŒéƒ¨ï¼‰"
date: 2025-08-06
description: "Linuxã§ãƒ«ãƒ¼ã‚¿ã‚’ä½œã‚‹ï¼ˆåŸºæœ¬æ©Ÿèƒ½æ§‹ç¯‰ç·¨ï¼‰"
tags: ["bet-all-on-systemd", "tech", "network", "linux"]
emoji: "ğŸ”—"
order: 2
---

***

<details>
  <summary>è¨˜äº‹ã®æ§‹æˆã«ã¤ã„ã¦</summary>

  ç¬¬äºŒéƒ¨ã§ã¯ã€Linuxãƒã‚·ãƒ³ã‚’ãƒ•ãƒ¬ãƒƒãƒ„ç¶²ã«æ¥ç¶šã—ã€åŸºæœ¬çš„ãªãƒ«ãƒ¼ã‚¿æ©Ÿèƒ½ã‚’æ§‹ç¯‰ã™ã‚‹ã€‚

  - [ç¬¬ä¸€éƒ¨ï¼šç’°å¢ƒæ§‹ç¯‰](./bet-all-on-systemd-1)
  - [ç¬¬äºŒéƒ¨ï¼šåŸºæœ¬æ©Ÿèƒ½æ§‹ç¯‰](./bet-all-on-systemd-2) :arrow\_left: ä»Šå›
  - [ç¬¬ä¸‰éƒ¨ï¼šHGWè¨­ç½®](./bet-all-on-systemd-3)
</details>

***

## æ‰‹é †2ï¼šåŸºæœ¬çš„ãªãƒ«ãƒ¼ã‚¿æ©Ÿèƒ½ã®æ§‹ç¯‰

ç¬¬ä¸€éƒ¨ã«ã¦ã€ã™ã§ã«[ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ§‹æˆã®æ¦‚è¦](./bet-all-on-systemd-1#ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ§‹æˆ)ã¯è¿°ã¹ãŸã€‚ãã®ãŸã‚ã€ç¬¬äºŒéƒ¨ã§ã¯è¨­å®šä¾‹ã‚’ä¸»ã«ç¤ºã—ã€è»½ãæ³¨é‡ˆã‚’åŠ ãˆã‚‹ã«ã¨ã©ã‚ã‚‹ã€‚

### ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã®æº–å‚™

æœ€åˆã«ã€å¿…è¦ãªä»®æƒ³ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’ã™ã¹ã¦ä½œæˆã—ã¦ãŠãã€‚

- ãƒ–ãƒªãƒƒã‚¸ï¼ˆ`br0`ï¼‰ã®ä½œæˆ

```systemd title="/etc/systemd/network/05-br0.netdev"
[NetDev]
Name=br0
Kind=bridge
# wan0ã‹ã‚‰MACã‚¢ãƒ‰ãƒ¬ã‚¹ï¼ˆãƒ©ãƒ³ãƒ€ãƒ åŒ–æ¸ˆã¿ï¼‰ã‚’ç¶™æ‰¿
MACAddress=none
```

```systemd title="/etc/systemd/network/05-br0.link"
[Match]
OriginalName=br0

[Link]
# wan0ã‹ã‚‰MACã‚¢ãƒ‰ãƒ¬ã‚¹ï¼ˆãƒ©ãƒ³ãƒ€ãƒ åŒ–æ¸ˆã¿ï¼‰ã‚’ç¶™æ‰¿
MACAddressPolicy=none
```

- VLANç”¨ã‚µãƒ–ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ï¼ˆ`home`ã€`hgw`ï¼‰ã®ä½œæˆ

```systemd title="/etc/systemd/network/10-home.netdev"
[NetDev]
Name=home
Kind=vlan

[VLAN]
Id=10
```

```systemd title="/etc/systemd/network/15-hgw.netdev"
[NetDev]
Name=hgw
Kind=vlan
# ä¸€å¿œ home ã¨ã¯åˆ¥ã®MACã‚¢ãƒ‰ãƒ¬ã‚¹ã«ã—ã¦ãŠã
MACAddress=de:ad:be:ef:00:03

[VLAN]
Id=100
```

- ã‚µãƒ–ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã¨ç‰©ç†ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ï¼ˆ`lan0`ï¼‰ã®ç´ã¥ã‘

```systemd title="/etc/systemd/network/01-lan0.network"
[Match]
Name=lan0

[Network]
VLAN=home
VLAN=hgw
LinkLocalAddressing=no
LLMNR=no
```

- `br0`ã®ãƒ¡ãƒ³ãƒãƒ¼ã«`wan0`ã‚’è¿½åŠ ï¼ˆ`hgw`ã¯ã‚ã¨ã§è¿½åŠ ã™ã‚‹ï¼‰

```systemd title="/etc/systemd/network/01-wan0.network"
[Match]
Name=wan0

[Network]
Bridge=br0
```

### ãƒ•ãƒ¬ãƒƒãƒ„ç¶²ã¸ã®æ¥ç¶š

#### IPv6 IPoE

DHCPv6ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’å‹•ã‹ã—ã€/56ã®ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’å—ã‘å–ã‚‹ã€‚

å—ã‘å–ã£ãŸãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã®ä¸€éƒ¨ï¼ˆ/64ï¼‰ã‹ã‚‰ã€é€šä¿¡ç”¨ã®ä¸€æ™‚ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼ˆRFC 4941ï¼‰ã¨ã€IPv4 over IPv6ç”¨ã®CEã‚¢ãƒ‰ãƒ¬ã‚¹ã‚‚å‰²ã‚Šå½“ã¦ã‚‹ã€‚

ï¼ˆã²ã‹ã‚Šé›»è©±é–¢é€£æƒ…å ±ã®å–å¾—ã«ã¤ã„ã¦ã¯æ¬¡å›è§¦ã‚Œã‚‹ï¼‰

```systemd title="/etc/systemd/network/05-br0.network"
[Match]
Name=br0

[Link]
RequiredForOnline=yes

[Network]
DHCP=ipv6
# èµ·å‹•ã”ã¨ã«ãƒªãƒ³ã‚¯ãƒ­ãƒ¼ã‚«ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å¤‰ãˆã‚‹
IPv6LinkLocalAddressGenerationMode=random
IPv6Forwarding=yes
IPv6AcceptRA=yes
# ä¸€æ™‚ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å‰²ã‚Šå½“ã¦ã‚‹
IPv6PrivacyExtensions=yes
DHCPPrefixDelegation=yes
Tunnel=mape0

[Route]
Gateway=_ipv6ra
# TCPã®åˆæœŸã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚µã‚¤ã‚ºã‚’å¤§ããã™ã‚‹
InitialCongestionWindow=30
InitialAdvertisedReceiveWindow=30

[DHCPv6]
DUIDType=link-layer
IAID=0
# DHCPv6ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«ä½™åˆ†ãªæƒ…å ±ã‚’å«ã‚ãªã„ã‚ˆã†ã«ã™ã‚‹
SendHostname=no
UseCaptivePortal=no
UseDNR=no

[DHCPPrefixDelegation]
UplinkInterface=:self
SubnetId=0
Announce=no
# CEã‚¢ãƒ‰ãƒ¬ã‚¹ã®å¾ŒåŠ64bitï¼ˆ= ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹IDï¼‰ã‚’æŒ‡å®š
Token=::ce
```

CEã‚¢ãƒ‰ãƒ¬ã‚¹ã¯`Network.Address=`ã§ã‚‚æŒ‡å®šã§ãã‚‹ãŒã€`DHCPPrefixDelegation.Token=`ã‚’ä½¿ã†ã¨å‰åŠã‚’æ›¸ã‹ãšã«æ¸ˆã‚€ãŸã‚ã€å°‘ã—æ¥½ã ã€‚

ãã®ã»ã‹ã€èµ·å‹•ã”ã¨ã«ãƒ©ãƒ³ãƒ€ãƒ ãªãƒªãƒ³ã‚¯ãƒ­ãƒ¼ã‚«ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å‰²ã‚Šå½“ã¦ã‚‹è¨­å®šã‚„ã€[TCPã®åˆæœŸã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚µã‚¤ã‚ºã‚’å¤§ããã™ã‚‹](https://wiki.archlinux.org/title/Systemd-networkd#Speeding_up_TCP_slow-start)è¨­å®šã‚‚ã—ã¦ã„ã‚‹ã€‚

#### IPv4 over IPv6

ãƒˆãƒ³ãƒãƒ«ãƒ‡ãƒã‚¤ã‚¹ï¼ˆ`mape0`ï¼‰ã‚’ä½œæˆã—ã€ãã®ä¸Šã«ãƒˆãƒ³ãƒãƒ«ã‚’å¼µã‚‹ã€‚

```systemd title="/etc/systemd/network/05-mape0.netdev"
[NetDev]
Name=mape0
Kind=ip6tnl

[Tunnel]
Mode=ipip6
# CEã‚¢ãƒ‰ãƒ¬ã‚¹
Local=3fff:0:0:ab00::ce
# BRã‚¢ãƒ‰ãƒ¬ã‚¹
Remote=2001:db8::1
DiscoverPathMTU=yes
EncapsulationLimit=none
```

```systemd title="/etc/systemd/network/05-mape0.network"
[Match]
Name=mape0

[Link]
RequiredForOnline=yes

[Network]
BindCarrier=br0
IPv4Forwarding=yes
LinkLocalAddressing=no
LLMNR=no
# DefaultRouteOnDevice=yes

[Route]
Gateway=0.0.0.0
InitialCongestionWindow=30
InitialAdvertisedReceiveWindow=30
```

ãªãŠ`[Route]` ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ä»£ã‚ã‚Šã«ã€`Network.DefaultRouteOnDevice=yes` ã‚’æŒ‡å®šã™ã‚‹ã“ã¨ã‚‚ã§ãã‚‹ã€‚åˆæœŸã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚µã‚¤ã‚ºã®æŒ‡å®šãŒä¸è¦ãªå ´åˆã€ãã¡ã‚‰ã®ã»ã†ãŒæ¥½ã ã‚ã†ã€‚

#### MAP-Eé–¢é€£ã®è¨­å®š

[å‰å›ç´¹ä»‹ã—ãŸè¨˜äº‹](https://turgenev.hatenablog.com/entry/2024/04/23/031222)ã«å€£ã„ã€`tc`ã‚’ä½¿ã£ãŸNATãªã©ã‚’è¨­å®šã™ã‚‹ã€‚iptablesã®ä»£ã‚ã‚Šã«nftablesã‚’ä½¿ã„ã€TCP MSSã®è‡ªå‹•èª¿æ•´ã‚’åŠ ãˆã¦ã„ã‚‹ç‚¹ä»¥å¤–ã¯ã€ãƒªãƒ³ã‚¯å…ˆã®è¨˜äº‹ã¨åŒã˜ã ã€‚

MSSã®èª¿æ•´ãƒ»fwmarkã®ä»˜ä¸ãƒ»ã‚½ãƒ¼ã‚¹NATã‚’è¡Œã†nftablesã®ãƒ«ãƒ¼ãƒ«ã‚’æ›¸ãã€‚

```NFTables title="/etc/nftables.d/lazy/mape0.nft"
#!/usr/sbin/nft -f

destroy table ip mape

table ip mape {
  chain mape-filter {
    type filter hook postrouting priority filter; policy accept;
    # TCP MSSã®èª¿æ•´
    iif "mape0" tcp flags syn tcp option maxseg size set rt mtu
    oif "mape0" tcp flags syn tcp option maxseg size set rt mtu
    # fwmarkã®ä»˜ä¸
    oif "mape0" meta l4proto tcp meta mark set 0x54 counter
    oif "mape0" meta l4proto udp meta mark set 0x55 counter
  }

  chain mape-snat {
    type nat hook postrouting priority srcnat; policy accept;
    # ã‚½ãƒ¼ã‚¹NATï¼ˆIPv4ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯å‰å›è¨ˆç®—ã—ãŸã‚‚ã®ã‚’ä½¿ã†ï¼‰
    oif "mape0" meta l4proto {tcp, udp, icmp} counter snat to 192.0.2.1:32784-33023
  }
}
```

èµ·å‹•æ™‚ã«å®Ÿè¡Œã™ã¹ã[^1]`tc`ã‚³ãƒãƒ³ãƒ‰ã‚‚ã€ã‚¹ã‚¯ãƒªãƒ—ãƒˆã«ã¾ã¨ã‚ã¦ãŠãã€‚

[^1]: `tc`ã‚³ãƒãƒ³ãƒ‰ã®åŠ¹æœã¯æ°¸ç¶šã—ãªã„ãŸã‚ã€å†èµ·å‹•ã”ã¨ã«å®Ÿè¡Œã™ã‚‹å¿…è¦ãŒã‚ã‚‹

```sh title="/usr/local/sbin/tc-mape0.sh"
#!/usr/bin/env bash

TUNNEL=mape0 # ãƒˆãƒ³ãƒãƒ«ãƒ‡ãƒã‚¤ã‚¹ã®åå‰
PSID=ab      # ãƒãƒ¼ãƒˆã‚»ãƒƒãƒˆIDï¼ˆ16é€²ï¼‰

# Out
tc qdisc replace dev $TUNNEL root handle 1: htb

tc filter add dev $TUNNEL parent 1: handle 0x55 fw action csum ip4h udp continue
tc filter add dev $TUNNEL parent 1: handle 0x54 fw action csum ip4h tcp continue
tc filter add dev $TUNNEL parent 1: handle 0x54/0xfffffffe fw action pedit pedit munge ip sport set "0x0${PSID}0" retain 0x0ff0 continue
tc filter add dev $TUNNEL parent 1: u32 match mark 0x54 0xfffffffe match ip sport 0x0010 0x0010 action pedit pedit munge ip sport set 0x1000 retain 0x1000 continue
tc filter add dev $TUNNEL parent 1: u32 match mark 0x54 0xfffffffe match ip sport 0x0020 0x0020 action pedit pedit munge ip sport set 0x2000 retain 0x2000 continue
tc filter add dev $TUNNEL parent 1: u32 match mark 0x54 0xfffffffe match ip sport 0x0040 0x0040 action pedit pedit munge ip sport set 0x4000 retain 0x4000 continue
tc filter add dev $TUNNEL parent 1: u32 match mark 0x54 0xfffffffe match ip sport 0x0000 0x0080 action pedit pedit munge ip sport set 0x0000 retain 0x8000 continue

# ICMP echo reply
tc filter add dev $TUNNEL parent 1: u32 match mark 0x59 0xffffffff action pedit pedit munge offset 24 u16 set "0x0${PSID}0" retain 0x0ff0 pipe action csum ip4h icmp continue
tc filter add dev $TUNNEL parent 1: u32 match mark 0x59 0xffffffff match u16 0x0010 0x0010 at 24 action pedit pedit munge offset 24 u16 set 0x1000 retain 0x1000 continue
tc filter add dev $TUNNEL parent 1: u32 match mark 0x59 0xffffffff match u16 0x0020 0x0020 at 24 action pedit pedit munge offset 24 u16 set 0x2000 retain 0x2000 continue
tc filter add dev $TUNNEL parent 1: u32 match mark 0x59 0xffffffff match u16 0x0040 0x0040 at 24 action pedit pedit munge offset 24 u16 set 0x4000 retain 0x4000 continue
tc filter add dev $TUNNEL parent 1: u32 match mark 0x59 0xffffffff match u16 0x0000 0x0080 at 24 action pedit pedit munge offset 24 u16 set 0x0000 retain 0x8000 continue
tc filter add dev $TUNNEL parent 1: u32 match ip protocol 1 0xff match ip icmp_type 8 0xff match ip ihl 0x5 0xf match u16 0 1fff at 6 action skbedit mark 0x59 continue

# In
tc qdisc add dev $TUNNEL ingress handle ffff:

tc filter add dev $TUNNEL parent ffff: handle 0x65 fw action csum ip4h udp continue
tc filter add dev $TUNNEL parent ffff: handle 0x64 fw action csum ip4h tcp continue
tc filter add dev $TUNNEL parent ffff: handle 0x64/0xfffffffe fw action pedit pedit munge ip dport set 0x8000 retain 0xf000 continue
tc filter add dev $TUNNEL parent ffff: u32 match mark 0x64 0xfffffffe match ip dport 0x8000 0x8000 action pedit pedit munge ip dport set 0x0080 retain 0x0080 continue
tc filter add dev $TUNNEL parent ffff: u32 match mark 0x64 0xfffffffe match ip dport 0x4000 0x4000 action pedit pedit munge ip dport set 0x0040 retain 0x0040 continue
tc filter add dev $TUNNEL parent ffff: u32 match mark 0x64 0xfffffffe match ip dport 0x2000 0x2000 action pedit pedit munge ip dport set 0x0020 retain 0x0020 continue
tc filter add dev $TUNNEL parent ffff: u32 match mark 0x64 0xfffffffe match ip dport 0x1000 0x1000 action pedit pedit munge ip dport set 0x0010 retain 0x0010 continue
tc filter add dev $TUNNEL parent ffff: u32 match mark 0x64 0xfffffffe action pedit pedit munge ip dport set 0 retain 0x0ff0 continue
tc filter add dev $TUNNEL parent ffff: u32 match ip protocol 17 0xff match u16 0 1fff at 6 match ip dport "0x0${PSID}0" 0x0ff0 action skbedit mark 0x65 continue
tc filter add dev $TUNNEL parent ffff: u32 match ip protocol 6 0xff match u16 0 1fff at 6 match ip dport "0x0${PSID}0" 0x0ff0 action skbedit mark 0x64 continue

# ICMP echo request
tc filter add dev $TUNNEL parent ffff: handle 0x69 fw action pedit pedit munge offset 24 u16 set 0x8000 retain 0xf000 pipe action csum ip4h icmp continue
tc filter add dev $TUNNEL parent ffff: u32 match mark 0x69 0xffffffff match u16 0x8000 0x8000 at 24 action pedit pedit munge offset 24 u16 set 0x0080 retain 0x0080 continue
tc filter add dev $TUNNEL parent ffff: u32 match mark 0x69 0xffffffff match u16 0x4000 0x4000 at 24 action pedit pedit munge offset 24 u16 set 0x0040 retain 0x0040 continue
tc filter add dev $TUNNEL parent ffff: u32 match mark 0x69 0xffffffff match u16 0x2000 0x2000 at 24 action pedit pedit munge offset 24 u16 set 0x0020 retain 0x0020 continue
tc filter add dev $TUNNEL parent ffff: u32 match mark 0x69 0xffffffff match u16 0x1000 0x1000 at 24 action pedit pedit munge offset 24 u16 set 0x0010 retain 0x0010 continue
tc filter add dev $TUNNEL parent ffff: u32 match mark 0x69 0xffffffff action pedit pedit munge offset 24 u16 set 0 retain 0x0ff0 continue
tc filter add dev $TUNNEL parent ffff: u32 match ip protocol 1 0xff match ip icmp_type 0 0xff match ip ihl 0x5 0xf match u16 0 1fff at 6 match u16 "0x0${PSID}0" 0x0ff0 at 24 action skbedit mark 0x69 continue

# port unreachable
tc filter add dev $TUNNEL parent ffff: handle 0x79 fw action pedit pedit munge offset 48 u16 set 0x8000 retain 0xf000 pipe action csum ip4h and icmp continue
tc filter add dev $TUNNEL parent ffff: u32 match mark 0x79 0xffffffff match ip dport 0x8000 0x8000 at 48 action pedit pedit munge offset 48 u16 set 0x0080 retain 0x0080 continue
tc filter add dev $TUNNEL parent ffff: u32 match mark 0x79 0xffffffff match ip dport 0x4000 0x4000 at 48 action pedit pedit munge offset 48 u16 set 0x0040 retain 0x0040 continue
tc filter add dev $TUNNEL parent ffff: u32 match mark 0x79 0xffffffff match ip dport 0x2000 0x2000 at 48 action pedit pedit munge offset 48 u16 set 0x0020 retain 0x0020 continue
tc filter add dev $TUNNEL parent ffff: u32 match mark 0x79 0xffffffff match ip dport 0x1000 0x1000 at 48 action pedit pedit munge offset 48 u16 set 0x0010 retain 0x0010 continue
tc filter add dev $TUNNEL parent ffff: handle 0x79 fw action pedit pedit munge offset 48 u16 set 0 retain 0x0ff0 continue
tc filter add dev $TUNNEL parent ffff: u32 match ip protocol 1 0xff match ip icmp_type 3 0xff match ip ihl 0x5 0xf match ip ihl 0x5 0xf at 28 match u16 0 1fff at 6 match ip sport "0x0${PSID}0" 0x0ff0 at 48 action skbedit mark 0x79 continue
```

èµ·å‹•å¾Œã€`mape0`ãƒ‡ãƒã‚¤ã‚¹ã®å­˜åœ¨ãŒä¿è¨¼ã•ã‚ŒãŸæ™‚ç‚¹ã§ãƒ«ãƒ¼ãƒ«ã¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒé©ç”¨ã•ã‚Œã‚‹ã‚ˆã†ã€systemdã‚µãƒ¼ãƒ“ã‚¹ã‚’è¨­å®šã™ã‚‹[^2]ã€‚

[^2]: ã‚‚ã¡ã‚ã‚“ã€nftablesã®ãƒ«ãƒ¼ãƒ«ã«é–¢ã—ã¦ã¯ã€å…¨ä½“ã®è¨­å®šï¼ˆ`/etc/nftables.conf`ï¼‰ã¨ã¾ã¨ã‚ã¦ã‚‚ã‚ˆã„ã€‚ã—ã‹ã—`mape0`ãƒ‡ãƒã‚¤ã‚¹ã®å­˜åœ¨ãŒä¿è¨¼ã•ã‚Œã¦ã„ã‚‹å ´åˆã€`iifname` / `oifname`[ã‚ˆã‚Šé«˜é€Ÿãª](https://serverfault.com/questions/985158/what-is-the-difference-between-iifname-and-iif-in-nftables/985167#985167)`iif` / `oif`ã¨ã„ã†æ§‹æ–‡ãŒä½¿ãˆã‚‹ãŸã‚ã€ã“ã®ã‚ˆã†ã«ã—ã¦ã„ã‚‹ï¼‰

```systemd title="/etc/systemd/system/nftables-mape0.service"
[Unit]
Description=Apply nftables filter rules for mape0
# ä¸‹ã®ã‚ˆã†ã«æ›¸ãã¨ã€ã“ã®ã‚µãƒ¼ãƒ“ã‚¹ã¯mape0ãƒ‡ãƒã‚¤ã‚¹ã®è¨­å®šå®Œäº†å¾Œã«å®Ÿè¡Œã•ã‚Œã‚‹
After=sys-subsystem-net-devices-mape0.device nftables.service
BindsTo=sys-subsystem-net-devices-mape0.device
Requires=nftables.service

[Service]
Type=oneshot
ExecStart=/usr/sbin/nft -f /etc/nftables.d/lazy/mape0.nft
RemainAfterExit=true

[Install]
WantedBy=multi-user.target
```

```systemd title="/etc/systemd/system/tc-mape0.service"
[Unit]
Description=Apply custom tc rules
Wants=network-online.target
After=network-online.target sys-subsystem-net-devices-mape0.device
BindsTo=sys-subsystem-net-devices-mape0.device

[Service]
Type=oneshot
RemainAfterExit=yes
ExecStart=/usr/local/sbin/tc-mape0.sh
ExecStop=/usr/sbin/tc filter del dev mape0 && /usr/sbin/tc filter del dev mape0 parent ffff:

[Install]
WantedBy=multi-user.target
```

```sh
systemctl enable nftables-mape0
systemctl enable tc-mape0
reboot
```

å¤©åœ°ã®é‹è¡ŒãŒæ­£å¸¸ã§ã€ã‚ãªãŸãŒç¥ç¦ã•ã‚Œã¦ã„ã‚Œã°ã€å†èµ·å‹•å¾Œã«IPv6 / IPv4ã®å°é€šãŒå–ã‚Œã‚‹ã¯ãšã ã€‚

```console
> ping -c3 2606:4700:4700::1001
PING 2606:4700:4700::1001 (2606:4700:4700::1001) 56 data bytes
64 bytes from 2606:4700:4700::1001: icmp_seq=1 ttl=54 time=7.45 ms
64 bytes from 2606:4700:4700::1001: icmp_seq=2 ttl=54 time=7.19 ms
64 bytes from 2606:4700:4700::1001: icmp_seq=3 ttl=54 time=7.12 ms

--- 2606:4700:4700::1001 ping statistics ---
3 packets transmitted, 3 received, 0% packet loss, time 2003ms
rtt min/avg/max/mdev = 7.123/7.254/7.451/0.141 ms
> ping -c3 1.0.0.1
PING 1.0.0.1 (1.0.0.1) 56(84) bytes of data.
64 bytes from 1.0.0.1: icmp_seq=1 ttl=58 time=7.36 ms
64 bytes from 1.0.0.1: icmp_seq=2 ttl=58 time=7.17 ms
64 bytes from 1.0.0.1: icmp_seq=3 ttl=58 time=7.84 ms

--- 1.0.0.1 ping statistics ---
3 packets transmitted, 3 received, 0% packet loss, time 2003ms
rtt min/avg/max/mdev = 7.172/7.458/7.839/0.280 ms
```

### å®…å†…æ©Ÿå™¨å´ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã®è¨­å®š

ç¶šã„ã¦å®…å†…æ©Ÿå™¨å´ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ï¼ˆ`home`ï¼‰ã‚’è¨­å®šã™ã‚‹ã€‚IPv6ã¯SLAAC + RDNSSã€IPv4ã¯DHCPv4ã‚’ä½¿ã†ã€ã‚ªãƒ¼ã‚½ãƒ‰ãƒƒã‚¯ã‚¹ãªæ§‹æˆã§ã‚ã‚‹ã€‚

```systemd title="/etc/systemd/network/10-home.network" {23,28}
[Match]
Name=home

[Network]
IPv6StableSecretAddress=xxxx:xxxx:xxxx:xxxx:xxxx:xxxx:xxxx:xxxx
IPv6Forwarding=yes
IPv6AcceptRA=no
IPv6SendRA=yes
DHCPPrefixDelegation=yes

Address=10.0.0.1/24
DHCPServer=yes
MulticastDNS=yes

[DHCPPrefixDelegation]
# ã“ã®ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã«/64ã®ã‚µãƒ–ãƒãƒƒãƒˆï¼ˆ3fff:0:0:ab01::/64ï¼‰ã‚’å‰²ã‚Šå½“ã¦ã‚‹
SubnetId=1
# ãŸã ã—ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹è‡ªä½“ã«ã¯ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å‰²ã‚ŠæŒ¯ã‚‰ãªã„
Assign=no

# å‰²ã‚Šå½“ã¦ãŸã‚µãƒ–ãƒãƒƒãƒˆã¨DNSã‚µãƒ¼ãƒã‚’RAã§é…å¸ƒã™ã‚‹
[IPv6SendRA]
DNS=_link_local
RouterLifetimeSec=9000
DNSLifetimeSec=14400

[DHCPServer]
DNS=_server_address
PoolOffset=32
PoolSize=208
DefaultLeaseTimeSec=24h
MaxLeaseTimeSec=48h

# IPv4ã®å›ºå®šã‚‚ãŠæ‰‹ã®ã‚‚ã®
[DHCPServerStaticLease]
MACAddress=de:ad:be:ef:00:04
Address=10.0.0.2
```

å…ˆã»ã©WANå´ï¼ˆ`br0`ï¼‰ã«IPv6ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ä»˜ã‘ãŸãŸã‚ã€ã“ã¡ã‚‰ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã«ã¯ä»˜ã‘ã¦ã„ãªã„ã€‚

`DNS=_link_local`ã‚„`DNS=_server_address`ã¨æ›¸ãã“ã¨ã§ã€ãƒ«ãƒ¼ã‚¿è‡ªèº«ã‚’DNSã‚µãƒ¼ãƒã¨ã—ã¦åºƒå‘Šã§ãã‚‹ã€‚ãƒ«ãƒ¼ã‚¿ä¸Šã§[DNSã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚µãƒ¼ãƒ](https://www.knot-resolver.cz/)ã‚’å‹•ã‹ã—ã¦ã„ã‚‹ãŸã‚ã€ã“ã®ã‚ˆã†ã«ã—ãŸã€‚

```sh
networkctl reload
```

è¨­å®šã‚’èª­ã¿è¾¼ã‚“ã å¾Œã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆç«¯æœ«ã‚’ã‚¹ã‚¤ãƒƒãƒã®é©åˆ‡ãªãƒãƒ¼ãƒˆã«ç¹‹ã’ã°ã€ãƒ«ãƒ¼ã‚¿ã¨ã—ã¦å‹•ä½œã—ã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚‹ã¯ãšã ã€‚

**ãªãŠã€ã“ã®æ™‚ç‚¹ã§æ¥ç¶šã—ãŸç«¯æœ«ã¯ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆã«éœ²å‡ºã™ã‚‹ã®ã§æ³¨æ„ã™ã‚‹ã“ã¨ã€‚**

### ãƒ•ã‚¡ã‚¤ã‚¢ã‚¦ã‚©ãƒ¼ãƒ«è¨­å®š

ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆå´ã‹ã‚‰ä¸¸è¦‹ãˆã¨ã„ã†ã®ã¯æ€–ã„ã®ã§ã€åŸºæœ¬çš„ãªãƒ•ã‚¡ã‚¤ã‚¢ã‚¦ã‚©ãƒ¼ãƒ«ã‚’è¨­å®šã—ã¦ãŠãã€‚ä»¥ä¸‹ã®è¨­å®šã¯ã¨ã‚Šã‚ãˆãšã®ã‚‚ã®ã ãŒã€æœ€ä½é™ã®æ©Ÿèƒ½ã¯æœãŸã—ã¦ãã‚Œã‚‹ã ã‚ã†ã€‚

```NFTables title="/etc/nftables.conf"
#!/usr/bin/nft -f

destroy table inet filter

table inet filter {
  set LANv4 {
    type ipv4_addr; flags interval;
    elements = { 10.0.0.0/8, 172.16.0.0/12, 192.168.0.0/16 }
  }

  set LANv6 {
    type ipv6_addr; flags interval;
    elements = { fd00::/8, fe80::/10 }
  }
  
  chain lan_input {
    meta l4proto { tcp, udp } th dport { 22, 53 } accept comment "allow LAN services"
  }

  chain input {
    type filter hook input priority filter; policy drop;

    ct state invalid drop comment "early drop of invalid connections"
    ct state { established, related } accept comment "allow tracked connections"
    iif lo accept comment "allow from loopback"
    ip6 nexthdr icmpv6 icmpv6 type { destination-unreachable, packet-too-big, time-exceeded, parameter-problem, echo-request, echo-reply } limit rate 5/second burst 10 packets accept
    ip6 nexthdr icmpv6 ip6 saddr fe80::/10 icmpv6 type { nd-router-solicit, nd-router-advert, nd-neighbor-solicit, nd-neighbor-advert, ind-neighbor-solicit, ind-neighbor-advert, 148, 149 } iifname "br0" accept
    ip6 nexthdr icmpv6 icmpv6 type { mld-listener-query, mld-listener-report, mld-listener-done, nd-router-solicit, nd-router-advert, nd-neighbor-solicit, nd-neighbor-advert, ind-neighbor-solicit, ind-neighbor-advert, mld2-listener-report, 148, 149, 151, 152, 153 } iifname "home" accept
    ip protocol icmp accept comment "allow icmp"
    udp dport bootps ip saddr 0.0.0.0 ip daddr 255.255.255.255 iifname "home" accept comment "allow dhcpv4"
    udp dport dhcpv6-server ip6 saddr fe80::/10 ip6 daddr ff02::1:2 iifname "home" accept comment "allow dhcpv6"
    udp dport dhcpv6-client iifname "br0" accept
    ip saddr @LANv4 jump lan_input comment "allow private services"
    ip6 saddr @LANv6 iifname "home" jump lan_input comment "allow private services"

    counter
  }

  chain forward {
    type filter hook forward priority filter; policy drop;

    iifname "home" ip protocol tcp tcp flags != syn / fin,syn,rst,ack ct state new counter reject with tcp reset
    meta protocol ip6 iifname "home" tcp flags != syn / fin,syn,rst,ack ct state new counter accept
    ct state invalid drop
    ct state { established, related } accept
    ip protocol icmp icmp type { destination-unreachable, time-exceeded, parameter-problem } accept
    ip6 nexthdr icmpv6 icmpv6 type { destination-unreachable, packet-too-big, time-exceeded, parameter-problem, echo-reply } accept

    meta l4proto { tcp, udp } th dport { 135, 137-139, 445 } oifname { "br0", "mape0" } counter drop
    iifname "home" oifname { "br0", "mape0" } accept

    counter
  }
}

include "/etc/nftables.d/*.nft"
```

```sh
systemctl enable --now nftables
```

***

ä»¥ä¸Šã§ã€åŸºæœ¬çš„ãªãƒ«ãƒ¼ã‚¿ã¨ã—ã¦ã®æ©Ÿèƒ½ã‚’å®Ÿç¾ã§ããŸã€‚[æœ€çµ‚å›ãƒ»ç¬¬ä¸‰éƒ¨](./bet-all-on-systemd-3)ã§ã¯ã€HGWã‚’ãƒ«ãƒ¼ã‚¿ã®ä¸‹æµã«è¨­ç½®ã—ã€ä»Šå›ã®è¨˜äº‹ã®æœ€çµ‚ç›®æ¨™ã‚’é”æˆã™ã‚‹ã€‚
